<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../cba-elements/src/dropdown/elm-dropdown.html">

<dom-module id="nv-lite-tool-bar">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
         :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            background-color: #FAFAFA;
            border-bottom: 1px solid #D9D9D9;
            height: 30px;
        }

        #bar {
            width: 99%;
            height: 30px;
            margin-left: 10px;
        }

        .zoom-bar {
            position: relative;
            width: 120px;
            height: 23px;
            box-sizing: border-box;
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc;
            background-color: #FFFFFF;
        }

        #progressBar {
            box-sizing: border-box;
            height: 100%;
            transition: all 0.2s;
            background-color: var(--accent-color);
        }
    </style>
    <template>
        <div id="bar" class="horizontal layout center">
            <div style="margin-left: 10px" class="elm-btn" title="Select any element (node /edge)" data-checked data-mode="select" on-click="handleMode">
                <i class="fa fa-hand-pointer-o" aria-hidden="true"></i>
            </div>
            <div style="border-left:0" class="elm-btn" title="Allows to move the whole network along the canvas" data-mode="move" on-click="handleMode">
                <i class="fa fa-hand-rock-o" aria-hidden="true"></i>
            </div>
            <elm-dropdown title="Select all nodes, all vertices or both" style="margin-left: 10px">
                <div data-button id="autoSelectButton" class="elm-btn">
                    <i class="fa fa-dot-circle-o"></i>
                </div>
                <ul data-menu id="autoSelectMenu">
                    <li on-mousedown="handleSelectMenu" data-value="All nodes">All nodes</li>
                    <li on-mousedown="handleSelectMenu" data-value="First neighbour nodes">First neighbour nodes</li>
                    <li on-mousedown="handleSelectMenu" data-value="Invert node selection">Invert node selection</li>
                    <li data-divider="true"></li>
                    <li on-mousedown="handleSelectMenu" data-value="All edges">All edges</li>
                    <li on-mousedown="handleSelectMenu" data-value="Adjacent edges">Adjacent edges</li>
                    <li data-divider="true"></li>
                    <li on-mousedown="handleSelectMenu" data-value="Everything">Everything</li>
                </ul>
            </elm-dropdown>
            <div style="border-left:0;margin-left: 0px" class="elm-btn elm-btn-shdw" title="Export SVG image" on-click="handleExportImage">
                <i class="fa fa-image"></i>
            </div>
            <div class="elm-btn elm-btn-shdw" title="Save layout" on-click="handleSaveLayout" style="border-left:0" >
                <i class="fa fa-save"></i>
            </div>
            <div style="margin-left: 10px" id="collapseButton" class="ocb-ctrl">
                <span class="ocb-icon icon-collapse"></span>
            </div>

            <elm-color-picker ctitle="Change the color of the background" id="backgroundColorPicker" color="{{backgroundColor}}" on-color-click="handleBackgroundColorPicker" style="float:left;width:90px;"></elm-color-picker>

            <elm-dropdown title="Rotate" style="margin-left: 10px">
                <div data-button id="rotateButton" class="elm-btn" style="border-right: none">
                    <i class="fa fa-rotate-right"></i>
                </div>
                <ul data-menu id="rotateMenu">
                    <li on-mousedown="handleRotateMenu" data-angle="45">45</li>
                    <li on-mousedown="handleRotateMenu" data-angle="90">90</li>
                    <li on-mousedown="handleRotateMenu" data-angle="180">180</li>
                    <li data-divider="true"></li>
                    <li on-mousedown="handleRotateMenu" data-angle="-45">-45</li>
                    <li on-mousedown="handleRotateMenu" data-angle="-90">-90</li>
                    <li on-mousedown="handleRotateMenu" data-angle="-180">-180</li>
                    <li data-divider="true"></li>
                    <li on-mousedown="handleRotateMenu" data-flip="horizontal">Flip horizontally</li>
                    <li on-mousedown="handleRotateMenu" data-flip="vertical">Flip vertically</li>
                </ul>
            </elm-dropdown>
            <input type="text" on-keyup="handleRotateField" id="rotateField" class="elm" style="width: 50px;" placeholder="90&deg;" pattern="^-?\d+$">

            <div title="Zoom out" id="zoomOutButton" on-click="handleZoomOutButton" class="elm-btn" style="margin-left: 10px">
                <i class="fa fa-minus"></i>
            </div>
            <div on-click="handleZoomSlider" class="zoom-bar">
                <div id="progressBar" style$={{computeZoomStyle(zoom)}}></div>
            </div>
            <div title="Zoom in" id="zoomInButton" on-click="handleZoomInButton" class="elm-btn">
                <i class="fa fa-plus"></i>
            </div>
            <!-- <div title="Reset zoom" id="resetZoomButton" on-click="handleResetZoomButton" class="elm-btn" style="margin-left: 10px">
                <i class="fa fa-television"></i>
            </div> -->
            <div title="Center network" id="centerNetworkButton" on-click="handleCenterNetworkButton" class="elm-btn" style="margin-left: 10px">
                <i class="fa fa-crosshairs"></i>
            </div>
            <div class="elm-btn elm-btn-shdw" title="Width adjust" on-click="handleAdjustWidthNetwork" style="border-left:0">
                <i class="fa fa-arrows-h"></i>
            </div>
            <div class="elm-btn elm-btn-shdw" title="Height adjust" on-click="handleAdjustHeightNetwork" style="border-left:0">
                <i class="fa fa-arrows-v"></i>
            </div>
            <div id="searchIcon" class="elm-btn" style="margin-left: 10px;border-right: none" title="Search">
                    <i class="fa fa-search" aria-hidden="true"></i>
            </div>
            <input on-keypress="handleVertexSearch" id="vertexSearchField" class="elm" type="text" placeholder="Search" style=" margin-right:10px; width: 15%">

            <!-- <div title="Help" id="helpButton" on-click="handleHelpButton" class="elm-btn" style="margin-left: 10px">
                <i class="fa fa-question-circle"></i>
            </div> -->
        </div>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'nv-lite-tool-bar',
        properties: {
            mode: {
                type: String,
                notify: true
            },
            lite: {
                type: Boolean,
                value: false
            },
            zoom: {
                type: Number,
                value: 25,
                notify: true
            },
            backgroundColor: {
                type: String,
                value: '#FFF',
                notify: true
            }
        },
        created: function() {},
        ready: function() {
            this.networkViewer = this.domHost;
            this.pathwayViewer = this.networkViewer.domHost;
        },

        handleLayoutMenu: function(e) {
            this.fire('layoutchange', {
                layout: e.currentTarget.dataset.value
            });
        },
        handleSelectMenu: function(e) {
            this.fire('selectchange', {
                select: e.currentTarget.dataset.value
            });
        },
        handleRotateMenu: function(e) {
            this.fire('rotatechange', e.currentTarget.dataset);
        },
        handleRotateField: function(e) {
            var query = e.target.value;
            var intPattern = /^-?\d+$/;
            if (intPattern.test(query)) {
                if (event.which === 13) {
                    this.fire('rotatechange', {
                        angle: parseFloat(query)
                    });
                }
            }
        },
        handleBackgroundColorPicker: function(e) {
            this.backgroundColor = e.detail.color;
        },
        handleZoomOutButton: function() {
            this.zoom = Math.max(0, this.zoom - 1)
        },
        handleZoomSlider: function(e) {
            var bcr = e.currentTarget.getBoundingClientRect();
            this.zoom = ((e.clientX - bcr.left) * 100) / bcr.width;
        },
        handleZoomInButton: function() {
            this.zoom = Math.min(100, this.zoom + 1)
        },
        handleResetZoomButton: function() {
            this.fire('reset-zoom');
        },
        handleCenterNetworkButton: function() {
            this.fire('center-network');
        },
        handleMode: function(e) {
            this.mode = e.currentTarget.dataset.mode;
            var els = Polymer.dom(this.root).querySelectorAll('[data-mode]');
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                if (el.dataset.mode != this.mode) {
                    el.removeAttribute('data-checked');
                } else {
                    el.setAttribute('data-checked', '');
                }
            }
        },
        setZoom: function(zoom) {
            this.zoom = zoom;
        },
        handleHelpButton: function() {
            window.open("https://github.com/babelomics/babelomics/wiki/Visualization-tools#network-viewer");
        },
        computeZoomStyle: function(zoom) {
            return 'width:' + zoom + '%';
        },

        handleUndo: function() {
            this.fire('undo');
        },

        handleRedo: function() {
            this.fire('redo');
        },
        handleSaveLayout: function() {
            //save current layout
            var nattFilePath=this.pathwayViewer.path +'/'+this.pathwayViewer.selectedCategory.id+'.natt'
            this.pathwayViewer.exportToNodeAttrFile(nattFilePath);
        },
        handleExportImage: function() {
            var text = this.networkViewer.exportSVG();
            var blob = new Blob([text], {
                type: "image/svg+xml"
            });
            if(this.pathwayViewer != null){
                saveAs(blob, this.pathwayViewer.leftTitle.replace(/[^a-zA-Z0-9._\-]/g, "_") + '.svg');
            }else{
                saveAs(blob, 'network.svg');
            }
        },
        handleCenterNetwork: function() {
            this.networkViewer.centerNetwork();
        },
        handleAdjustWidthNetwork: function() {
            this.networkViewer.adjustWidthNetwork();
        },
        handleAdjustHeightNetwork: function() {
            this.networkViewer.adjustHeightNetwork();
        },
        handleVertexSearch: function(e) {
            //e.which == 13
            if(e.which!=13)
                var valueToSearch = e.currentTarget.value+e.key;
            else
                var valueToSearch = e.currentTarget.value;
            if(true)
            {

                //var nv =document.getElementsByTagName("network-viewer")[1];
                var nv = this.networkViewer;
                str = 'all attributes';
                var selected = [];
                for (var i = 0; i < nv.graph.vertices.length; i++) {
                    var vertex = nv.graph.vertices[i];
                    var vertixToCheck = ['genesList', 'label'];
                    for (var att of vertixToCheck) {                            
                        if (vertex.attributes[att].toString().toUpperCase().indexOf(valueToSearch.toUpperCase()) != -1) {
                            selected.push(vertex);
                            break;
                        }
                    }
                }
                nv.set('selectedVertices', selected);
                if (nv.selectedVertices.length == 0) {
                    elm.utils.msg('Search results', 'Your search using "' + valueToSearch + '" did not match any node.');
                } else {
                    elm.utils.msg('Search results', nv.selectedVertices.length + ' nodes found using ' + str + '. The found nodes has been selected.');
                }
            }
        }
    });
</script>
